#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

# fail fast
set -e

BP_DIR=$(cd $(dirname $0)/..; pwd) # absolute path
BIN_DIR=$BP_DIR/bin

# parse args
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

JVM_COMMON_BUILDPACK=${JVM_COMMON_BUILDPACK:-"https://codon-buildpacks.s3.amazonaws.com/buildpacks/heroku/jvm-common.tgz"}
mkdir -p /tmp/jvm-common
curl --retry 3 --silent --location $JVM_COMMON_BUILDPACK | tar xzm -C /tmp/jvm-common --strip-components=1
. /tmp/jvm-common/bin/util
. /tmp/jvm-common/bin/java

install_java_with_overlay ${BUILD_DIR}

JBOSS_HOME=".jboss/singular-platform-1.1.0/wildfly"

cd $BUILD_DIR

mkdir -p .jboss

echo -n "-----> Installing Wildfly ... "
wget "https://objects.githubusercontent.com/github-production-release-asset-2e65be/81475886/8b405c64-b4b7-11e7-9b59-95cc65f45cf7?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAIWNJYAX4CSVEH53A%2F20220502%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20220502T003856Z&X-Amz-Expires=300&X-Amz-Signature=bb3295140ffa42eb70221e27424a3a9d1c13453c51c75728ae75103df07fb347&X-Amz-SignedHeaders=host&actor_id=39447575&key_id=0&repo_id=81475886&response-content-disposition=attachment%3B%20filename%3Dsingular-platform-1.1.0.tar.gz&response-content-type=application%2Foctet-stream"
echo "downloaded"
ls
tar -xf singular-platform-1.1.0.tar.gz
ls
echo "extracted"
mv singular-platform-1.1.0 .jboss
echo "moved"
rm singular-platform-1.1.0.tar.gz
echo "done"

echo -n "-----> Downloading Artifacts..."
echo "... Static Resources ..."
curl -o https://repo1.maven.org/maven2/org/opensingular/requirement-sample-static-resources/1.8.2.1/requirement-sample-static-resources-1.8.2.1.war
echo "... Show Case ..."
curl -o https://repo1.maven.org/maven2/org/opensingular/singular-ui-showcase/1.8.2.1/singular-ui-showcase-1.8.2.1.war
echo "... done"

echo -n "-----> Deploying war file(s)... "
cp *.war $JBOSS_HOME/standalone/deployments/
echo "done"

echo "-----> Creating configuration..."
if [ -f $BUILD_DIR/Procfile ]; then
  echo "        WARNING: overwriting existing Procfile"
fi

cat << EOF > $BUILD_DIR/Procfile
web: \$JBOSS_HOME/bin/standalone.sh -b=0.0.0.0 -Djboss.http.port=\$PORT
EOF

cat << EOF > $BUILD_DIR/.profile.d/jboss.sh
export JBOSS_HOME=${JBOSS_HOME}
EOF
